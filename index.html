<!DOCTYPE html>
<html lang="en" ng-app="regenApp">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Re-Gen AI Chat & Image Generator</title>
  <!-- AngularJS + ngAnimate -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular-animate.min.js"></script>
  <style>
    /* ... [all your existing CSS remains unchanged] ... */
  </style>
</head>
<body ng-controller="MainCtrl as vm">
  <div class="container">
    <div class="sidebar">
      <!-- ... [sidebar content unchanged] ... -->
    </div>

    <div class="main">
      <!-- ... [main panel content unchanged] ... -->
    </div>
  </div>

  <script>
    angular.module('regenApp', ['ngAnimate'])
    .controller('MainCtrl', function($http, $timeout) {
      var vm = this;
      vm.mode = 'chat';
      vm.username = '';
      vm.temperature = 1;
      vm.messages = [];
      vm.chatText = '';
      vm.loading = false;

      vm.imgPrompt = '';
      vm.imgUrl = '';
      vm.imgLoading = false;

      vm.switch = function(mode){ vm.mode = mode; };
      vm.clearAll = function(){ vm.messages = []; vm.chatText=''; scrollChat(); };
      vm.clearImage = function(){ vm.imgPrompt=''; vm.imgUrl=''; };

      function scrollChat(){
        $timeout(()=>{ 
          var chat = document.getElementById('chatMessages'); 
          if(chat) chat.scrollTop = chat.scrollHeight; 
        }, 50);
      }

      vm.sendChat = function(){
        if(!vm.chatText || vm.loading) return;
        var userMsg = {role:'user', content: vm.chatText, ts:new Date()};
        vm.messages.push(userMsg);
        var payload = vm.chatText;
        vm.chatText='';
        vm.loading=true;
        scrollChat();

        const url = 'https://llama-3-2-3b1.p.rapidapi.com/chat_completions';
        const data = {
          messages: [
            { role: 'system', content: 'You are a helpful assistant.' },
            { role: 'user', content: payload }
          ],
          temperature: parseFloat(vm.temperature),
          top_p: 1,
          frequency_penalty: 0,
          presence_penalty: 0,
          max_tokens: 512
        };

        $http({
          method:'POST',
          url:url,
          headers:{
            'Content-Type':'application/json',
            'x-rapidapi-host':'llama-3-2-3b1.p.rapidapi.com',
            'x-rapidapi-key':'82ae10db11mshb41ccacdd991130p108a22jsnf3ae22b94bbd'
          },
          data:data
        }).then(function(res){
          // LLaMA response may be in res.data.response or res.data.choices[0].message.content
          var botReply = (res.data?.choices?.[0]?.message?.content) || res.data?.response || '(no reply)';
          vm.messages.push({role:'bot', content: botReply, ts:new Date()});
          scrollChat();
        }).catch(function(err){
          vm.messages.push({role:'bot', content:'[Error: '+(err.statusText||err.status||'failed')+']', ts:new Date()});
          scrollChat();
        }).finally(function(){
          vm.loading=false;
        });
      };

      vm.quickUplift = function(){
        vm.messages.push({role:'bot', content:'ðŸŒŸ You are capable of amazing things. Keep going!', ts:new Date()});
        scrollChat();
      };

      vm.generateImage = function(){
        if(!vm.imgPrompt) return;
        vm.imgLoading=true;
        $http.post('https://api-inference.huggingface.co/models/your-flux-model',{
          inputs: vm.imgPrompt
        },{
          headers:{'Authorization':'Bearer YOUR_HF_TOKEN'}
        }).then(function(res){
          if(res.data && res.data.url){
            vm.imgUrl=res.data.url;
          }
        }).catch(function(){
          vm.imgUrl='';
        }).finally(function(){ vm.imgLoading=false; });
      };
    });
  </script>
</body>
</html>
